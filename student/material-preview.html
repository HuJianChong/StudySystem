<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教材</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .chapter-list {
            transition: max-height 0.3s ease;
            overflow: hidden;
        }
        .chapter-list.open {
            max-height: 500px;
        }
        .chapter-list.closed {
            max-height: 0;
        }
        .chapter-btn.active {
            background: #e0e7ff;
            color: #3730a3;
        }
        .attachment-card {
            transition: transform 0.2s;
        }
        .attachment-card:hover {
            transform: translateY(-2px);
        }
        .highlight {
            background-color: #fef3c7;
            cursor: pointer;
            position: relative;
        }
        .annotation-panel {
            width: 280px;
            transition: transform 0.3s ease;
        }
        .annotation-item {
            position: absolute;
            left: 0;
            width: 100%;
            padding: 12px;
            background: #fff;
            border-left: 3px solid #fbbf24;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        #annotations-container {
            position: relative;
            min-height: 400px;
        }
        .comment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .context-menu {
            display: none;
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .context-menu button {
            display: block;
            width: 100%;
            padding: 8px 16px;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
        }
        .context-menu button:hover {
            background: #f3f4f6;
        }
        .comment-marker {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            margin-left: 8px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            vertical-align: middle;
        }
        .comment-marker:hover {
            color: #2563eb;
        }
        .comment-marker i {
            font-size: 16px;
        }
        .comment-highlight {
            background-color: #f0f9ff;
            border-bottom: 2px dashed #0369a1;
        }
        /* 悬浮记笔记按钮 */
        .floating-btn {
            position: fixed;
            right: 30px;
            bottom: 30px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }
        .floating-btn:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .floating-btn i {
            font-size: 24px;
        }
        /* 笔记弹框 */
        .note-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .note-editor {
            min-height: 200px;
            resize: vertical;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen"  oncontextmenu="return false;">
    <div class="max-w-6xl mx-auto p-6">
        <div class="flex items-center mb-6">
            <button id="toggle-chapter-list" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded flex items-center text-sm mr-4">
                <i class="fas fa-list mr-2"></i> 章节
            </button>
            <h1 class="text-2xl font-bold text-gray-800">教材</h1>
        </div>
        <div class="flex gap-6">
            <!-- 左侧章节列表 -->
            <div id="chapter-list-panel" class="w-64 min-w-[200px] bg-white rounded shadow p-0 flex flex-col hidden">
                <div class="flex items-center justify-between px-4 py-3 border-b">
                    <span class="font-semibold text-gray-700 text-lg">章节</span>
                </div>
                <ul id="chapter-list" class="divide-y divide-gray-100 flex-1 overflow-y-auto">
                    <!-- 动态章节列表 -->
                </ul>
            </div>
            <!-- 中间正文内容 -->
            <div class="flex-1 bg-white rounded shadow p-6 min-h-[400px]">
                <h2 id="chapter-title" class="text-xl font-semibold text-gray-800 mb-4">正文</h2>
                <div id="chapter-content" class="prose max-w-none text-gray-800">
                    这里是教材正文内容。请在编辑页面编辑并保存后，预览效果会在此处显示。
                </div>
            </div>
            <!-- 右侧批注面板 -->
            <div id="annotation-panel" class="annotation-panel bg-white rounded shadow p-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">批注列表</h3>
                <div id="annotations-container" class="space-y-4">
                    <!-- 批注内容将动态添加到这里 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div id="context-menu" class="context-menu">
        <button id="add-annotation-btn">
            <i class="fas fa-sticky-note mr-2"></i>添加批注
        </button>
        <button id="add-comment-btn">
            <i class="fas fa-comments mr-2"></i>添加评论
        </button>
    </div>

    <!-- 评论模态框 -->
    <div id="comment-modal" class="comment-modal">
        <div class="fixed inset-0 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
                <div class="p-4 border-b">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-semibold text-gray-900">评论</h3>
                        <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="p-4 max-h-[400px] overflow-y-auto" id="comments-container">
                    <!-- 评论列表将动态添加到这里 -->
                </div>
                <div class="p-4 border-t">
                    <div class="flex gap-2">
                        <input type="text" id="comment-input" placeholder="输入评论..." 
                            class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="submit-comment" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            发送
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 记笔记按钮 -->
    <div class="floating-btn" id="note-btn">
        <i class="fas fa-pen-to-square"></i>
    </div>

    <!-- 笔记弹框 -->
    <div id="note-modal" class="note-modal">
        <div class="fixed inset-0 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4">
                <div class="p-4 border-b flex items-center justify-between">
                    <h3 class="text-xl font-semibold text-gray-900">笔记</h3>
                    <button id="close-note-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-4">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            当前章节：<span id="current-chapter-title" class="text-gray-900"></span>
                        </label>
                        <textarea id="note-content" 
                            class="note-editor w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="在这里记笔记..."></textarea>
                    </div>
                    <div class="text-right space-x-3">
                        <button id="save-note" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            保存笔记
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 示例章节数据
        const chapters = [
            { 
                title: '第一章 绪论', 
                content: `
                    <h3>1.1 课程简介</h3>
                    <p>本章介绍Python语言的发展历史、应用领域及其优势。</p>
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h4 class="text-blue-800 font-semibold">学习目标</h4>
                        <ul class="list-disc list-inside text-blue-700">
                            <li>了解Python的发展历史</li>
                            <li>掌握Python的应用领域</li>
                            <li>理解Python的优势</li>
                        </ul>
                    </div>
                    <img src="https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?w=800&auto=format&fit=crop&q=80" alt="Python发展历程" class="rounded-lg shadow-lg my-4">
                    <h3>1.2 Python的起源与发展</h3>
                    <p>Python由荷兰人Guido van Rossum于1989年底发明，第一个公开发行版发行于1991年。</p>
                    <div class="grid grid-cols-2 gap-4 my-4">
                        <img src="https://images.unsplash.com/photo-1542831371-29b0f74f9713?w=400&auto=format&fit=crop&q=80" alt="Python编程" class="rounded-lg shadow">
                        <img src="https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=400&auto=format&fit=crop&q=80" alt="代码编辑器" class="rounded-lg shadow">
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg my-4">
                        <p class="text-yellow-800"><i class="fas fa-lightbulb mr-2"></i>小贴士：Python的名字来源于英国喜剧团体Monty Python。</p>
                    </div>
                    <h3>1.3 相关资源</h3>
                    <div class="grid grid-cols-2 gap-4 my-4">
                        <div class="attachment-card bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex items-center">
                                <i class="fas fa-file-pdf text-red-500 text-2xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold">Python学习路线图</h4>
                                    <p class="text-sm text-gray-600">PDF文档 - 2.5MB</p>
                                </div>
                            </div>
                        </div>
                        <div class="attachment-card bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex items-center">
                                <i class="fas fa-file-video text-purple-500 text-2xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold">Python发展史视频</h4>
                                    <p class="text-sm text-gray-600">MP4视频 - 15分钟</p>
                                </div>
                            </div>
                        </div>
                    </div>
                ` 
            },
            { 
                title: '第二章 基础语法', 
                content: `
                    <h3>2.1 变量与数据类型</h3>
                    <p>本章讲解Python的基本语法，包括变量定义、常用数据类型、输入输出等。</p>
                    <div class="bg-green-50 p-4 rounded-lg my-4">
                        <h4 class="text-green-800 font-semibold">关键概念</h4>
                        <ul class="list-disc list-inside text-green-700">
                            <li>变量命名规则</li>
                            <li>基本数据类型</li>
                            <li>类型转换</li>
                        </ul>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg my-4 font-mono">
                        <pre><code># 变量命名示例
student_name = "张三"  # 下划线命名法
className = "Python基础"  # 驼峰命名法
                        
# 数据类型示例
age = 18  # 整数
height = 1.75  # 浮点数
name = "李四"  # 字符串
is_student = True  # 布尔值</code></pre>
                    </div>
                    <h3>2.2 练习题</h3>
                    <div class="bg-purple-50 p-4 rounded-lg my-4">
                        <h4 class="text-purple-800 font-semibold">实践作业</h4>
                        <ol class="list-decimal list-inside text-purple-700">
                            <li>创建三个不同类型的变量</li>
                            <li>实现简单的类型转换</li>
                            <li>编写输入输出程序</li>
                        </ol>
                    </div>
                    <div class="grid grid-cols-2 gap-4 my-4">
                        <div class="attachment-card bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex items-center">
                                <i class="fas fa-file-code text-blue-500 text-2xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold">练习代码模板</h4>
                                    <p class="text-sm text-gray-600">Python文件 - 1.2KB</p>
                                </div>
                            </div>
                        </div>
                        <div class="attachment-card bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex items-center">
                                <i class="fas fa-file-excel text-green-500 text-2xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold">课后作业</h4>
                                    <p class="text-sm text-gray-600">Excel文档 - 500KB</p>
                                </div>
                            </div>
                        </div>
                    </div>
                ` 
            },
            {
                title: '第三章 流程控制',
                content: `
                    <h3>3.1 条件语句</h3>
                    <p>本章介绍Python中的流程控制语句，包括if条件语句、循环语句等。</p>
                    <div class="bg-indigo-50 p-4 rounded-lg my-4">
                        <h4 class="text-indigo-800 font-semibold">本节要点</h4>
                        <ul class="list-disc list-inside text-indigo-700">
                            <li>if-else语句</li>
                            <li>elif的使用</li>
                            <li>嵌套条件</li>
                        </ul>
                    </div>
                    <img src="https://images.unsplash.com/photo-1516116216624-53e697fedbea?w=600&auto=format&fit=crop&q=80" alt="流程图" class="rounded-lg shadow-lg my-4">
                    <div class="bg-gray-100 p-4 rounded-lg my-4 font-mono">
                        <pre><code># 条件语句示例
score = 85

if score >= 90:
    print("优秀")
elif score >= 80:
    print("良好")
elif score >= 60:
    print("及格")
else:
    print("不及格")</code></pre>
                    </div>
                    <h3>3.2 多媒体资源</h3>
                    <div class="grid grid-cols-3 gap-4 my-4">
                        <div class="attachment-card bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex items-center">
                                <i class="fas fa-file-powerpoint text-red-500 text-2xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold">课件</h4>
                                    <p class="text-sm text-gray-600">PPT - 5MB</p>
                                </div>
                            </div>
                        </div>
                        <div class="attachment-card bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex items-center">
                                <i class="fas fa-file-audio text-yellow-500 text-2xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold">课程录音</h4>
                                    <p class="text-sm text-gray-600">MP3 - 30分钟</p>
                                </div>
                            </div>
                        </div>
                        <div class="attachment-card bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex items-center">
                                <i class="fas fa-file-image text-pink-500 text-2xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold">思维导图</h4>
                                    <p class="text-sm text-gray-600">PNG - 1.8MB</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                title: '第四章 函数',
                content: `
                    <h3>4.1 函数定义与调用</h3>
                    <p>本章讲解Python函数的定义、参数传递、返回值等内容。</p>
                    <div class="bg-red-50 p-4 rounded-lg my-4">
                        <h4 class="text-red-800 font-semibold">重点内容</h4>
                        <ul class="list-disc list-inside text-red-700">
                            <li>函数的基本结构</li>
                            <li>参数类型</li>
                            <li>返回值处理</li>
                        </ul>
                    </div>
                    <div class="grid grid-cols-2 gap-4 my-4">
                        <img src="https://images.unsplash.com/photo-1461749280684-dccba630e2f6?w=500&auto=format&fit=crop&q=80" alt="函数结构图" class="rounded-lg shadow">
                        <div class="bg-gray-100 p-4 rounded-lg font-mono">
                            <pre><code>def calculate_area(length, width):
    """计算矩形面积"""
    area = length * width
    return area

# 调用函数
result = calculate_area(5, 3)
print(f"面积是: {result}")</code></pre>
                        </div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg my-4">
                        <h4 class="text-orange-800 font-semibold"><i class="fas fa-exclamation-triangle mr-2"></i>注意事项</h4>
                        <ul class="list-disc list-inside text-orange-700">
                            <li>函数名应该具有描述性</li>
                            <li>注意参数的默认值</li>
                            <li>返回值类型的一致性</li>
                        </ul>
                    </div>
                    <h3>4.2 课程资源</h3>
                    <div class="grid grid-cols-2 gap-4 my-4">
                        <div class="attachment-card bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex items-center">
                                <i class="fas fa-file-archive text-orange-500 text-2xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold">示例代码包</h4>
                                    <p class="text-sm text-gray-600">ZIP - 3.5MB</p>
                                </div>
                            </div>
                        </div>
                        <div class="attachment-card bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex items-center">
                                <i class="fas fa-file-word text-blue-500 text-2xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold">实验指导书</h4>
                                    <p class="text-sm text-gray-600">Word - 2.1MB</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            }
        ];
        let currentChapter = -1;
        // 渲染章节列表
        function renderChapterList() {
            const list = document.getElementById('chapter-list');
            list.innerHTML = '';
            chapters.forEach((ch, idx) => {
                const li = document.createElement('li');
                li.innerHTML = `<button class='w-full text-left px-4 py-2 chapter-btn' data-idx='${idx}'>${ch.title}</button>`;
                list.appendChild(li);
            });
            // 按钮事件
            document.querySelectorAll('.chapter-btn').forEach(btn => {
                btn.onclick = function() {
                    const idx = parseInt(this.getAttribute('data-idx'));
                    showChapter(idx);
                };
            });
        }
        // 显示章节内容
        function showChapter(idx) {
            currentChapter = idx;
            document.getElementById('chapter-title').textContent = chapters[idx].title;
            document.getElementById('chapter-content').innerHTML = chapters[idx].content;
            document.querySelectorAll('.chapter-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === idx);
            });
            
            // 更新笔记按钮状态
            const noteBtn = document.getElementById('note-btn');
            if (notes[idx]) {
                noteBtn.setAttribute('title', '查看笔记');
                noteBtn.style.backgroundColor = '#3b82f6';  // 有笔记时的颜色
            } else {
                noteBtn.setAttribute('title', '添加笔记');
                noteBtn.style.backgroundColor = '#6b7280';  // 无笔记时的颜色
            }
        }
        // 章节展开/收起按钮逻辑
        document.getElementById('toggle-chapter-list').onclick = function() {
            const panel = document.getElementById('chapter-list-panel');
            panel.classList.toggle('hidden');
        };
        // 批注和评论功能
        let selectedText = '';
        let selectedRange = null;
        let annotations = [];
        let comments = [];
        let notes = {};  // 存储各章节的笔记

        // 计算选中文本的位置
        function getSelectionPosition() {
            const range = selectedRange;
            const rect = range.getBoundingClientRect();
            const contentContainer = document.getElementById('chapter-content');
            const containerRect = contentContainer.getBoundingClientRect();
            return {
                top: rect.top - containerRect.top,
                height: rect.height
            };
        }

        // 查找可用的批注位置
        function findAvailablePosition(newAnnotation, yPosition) {
            const container = document.getElementById('annotations-container');
            const existingAnnotations = Array.from(container.children);
            let position = yPosition;
            
            // 对现有批注按位置排序
            const sortedAnnotations = existingAnnotations
                .map(el => ({
                    element: el,
                    top: parseInt(el.style.top)
                }))
                .sort((a, b) => a.top - b.top);

            // 检查每个位置是否有重叠
            for (let i = 0; i < sortedAnnotations.length; i++) {
                const current = sortedAnnotations[i];
                const next = sortedAnnotations[i + 1];
                
                // 如果当前位置可用
                if (position + 100 <= current.top) {
                    return position;
                }
                
                // 检查当前批注和下一个批注之间是否有足够空间
                if (next && (next.top - (current.top + 100) >= 100)) {
                    return current.top + 100;
                }
                
                position = current.top + 100;
            }
            
            // 如果没有找到合适的位置，放在最后
            return position;
        }

        // 更新批注面板
        function updateAnnotationPanel() {
            const container = document.getElementById('annotations-container');
            container.innerHTML = '';
            
            annotations.forEach((anno, index) => {
                const div = document.createElement('div');
                div.className = 'annotation-item';
                div.innerHTML = `
                    <p class="text-sm text-gray-600 mb-2">"${anno.text}"</p>
                    <p class="text-gray-800">${anno.note}</p>
                `;
                
                // 计算初始位置
                let yPosition = anno.position || 0;
                // 找到可用位置
                yPosition = findAvailablePosition(div, yPosition);
                
                div.style.top = `${yPosition}px`;
                container.appendChild(div);
                
                // 更新批注位置信息
                anno.position = yPosition;
            });
        }

        // 添加批注
        document.getElementById('add-annotation-btn').addEventListener('click', function() {
            if (selectedText && selectedRange) {
                const span = document.createElement('span');
                span.className = 'highlight';
                span.textContent = selectedText;
                
                // 获取选中文本的位置
                const position = getSelectionPosition();
                
                const annotation = {
                    id: Date.now(),
                    text: selectedText,
                    note: prompt('请输入批注内容：') || '无批注内容',
                    position: position.top // 保存初始位置
                };
                
                annotations.push(annotation);
                selectedRange.surroundContents(span);
                updateAnnotationPanel();
                
                document.getElementById('context-menu').style.display = 'none';
            }
        });

        // 添加评论
        document.getElementById('add-comment-btn').addEventListener('click', function() {
            if (selectedText) {
                const comment = {
                    id: Date.now(),
                    text: selectedText,
                    comments: []
                };
                comments.push(comment);

                // 创建评论图标
                const marker = document.createElement('span');
                marker.className = 'comment-marker';
                marker.innerHTML = '<i class="fas fa-comment"></i>';
                marker.setAttribute('data-comment-id', comment.id);
                marker.setAttribute('title', '点击查看评论');
                marker.onclick = function(e) {
                    e.stopPropagation();
                    showCommentModal(comment);
                };
                
                // 在选中文本后插入评论图标
                const range = selectedRange.cloneRange();
                range.collapse(false);
                range.insertNode(marker);
                
                showCommentModal(comment);
                document.getElementById('context-menu').style.display = 'none';
            }
        });

        // 更新评论标记
        function updateCommentMarker(comment) {
            const marker = document.querySelector(`[data-comment-id="${comment.id}"]`);
            if (marker) {
                // 更新图标的title属性显示评论数量
                marker.setAttribute('title', `${comment.comments.length}条评论`);
                // 如果有评论，使用实心图标；没有评论，使用空心图标
                marker.innerHTML = `<i class="fa${comment.comments.length > 0 ? 's' : 'r'} fa-comment"></i>`;
            }
        }

        // 显示评论模态框
        function showCommentModal(comment) {
            const modal = document.getElementById('comment-modal');
            const container = document.getElementById('comments-container');
            modal.style.display = 'block';
            
            function updateComments() {
                container.innerHTML = `
                    <div class="bg-gray-50 p-3 rounded-lg mb-4">
                        <p class="text-gray-600 mb-2">原文：</p>
                        <p class="text-gray-800">"${comment.text}"</p>
                    </div>
                    ${comment.comments.map(c => `
                        <div class="bg-white p-3 rounded-lg shadow-sm mb-2">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-blue-500"></i>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">学生</p>
                                    <p class="text-gray-800">${c.content}</p>
                                    <p class="text-xs text-gray-500 mt-1">${new Date(c.time).toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                `;
                // 更新评论标记
                updateCommentMarker(comment);
            }
            
            updateComments();

            // 提交评论
            document.getElementById('submit-comment').onclick = function() {
                const input = document.getElementById('comment-input');
                const content = input.value.trim();
                if (content) {
                    comment.comments.push({
                        content: content,
                        time: Date.now()
                    });
                    input.value = '';
                    updateComments();
                }
            };

            // 回车提交评论
            document.getElementById('comment-input').onkeypress = function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('submit-comment').click();
                }
            };

            // 关闭模态框
            document.getElementById('close-modal').onclick = function() {
                modal.style.display = 'none';
            };

            // 点击模态框外部关闭
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }

        // 打开笔记弹框
        document.getElementById('note-btn').addEventListener('click', function() {
            const noteModal = document.getElementById('note-modal');
            const currentChapterTitle = chapters[currentChapter].title;
            document.getElementById('current-chapter-title').textContent = currentChapterTitle;
            
            // 显示已有笔记
            const existingNote = notes[currentChapter] || '';
            document.getElementById('note-content').value = existingNote;
            
            noteModal.style.display = 'block';
        });

        // 关闭笔记弹框
        document.getElementById('close-note-modal').addEventListener('click', function() {
            document.getElementById('note-modal').style.display = 'none';
        });

        // 点击弹框外部关闭
        document.getElementById('note-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // 保存笔记
        document.getElementById('save-note').addEventListener('click', function() {
            const content = document.getElementById('note-content').value.trim();
            notes[currentChapter] = content;
            
            // 显示保存成功提示
            const saveBtn = this;
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-check mr-1"></i>已保存';
            saveBtn.disabled = true;
            
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                document.getElementById('note-modal').style.display = 'none';
            }, 1500);
        });

        // 支持快捷键
        document.addEventListener('keydown', function(e) {
            // Alt + N 打开笔记
            if (e.altKey && e.key === 'n') {
                e.preventDefault();
                document.getElementById('note-btn').click();
            }
            
            // Ctrl + Enter 保存笔记（当笔记弹框打开时）
            if (e.ctrlKey && e.key === 'Enter' && document.getElementById('note-modal').style.display === 'block') {
                e.preventDefault();
                document.getElementById('save-note').click();
            }
        });

        // 初始化
        renderChapterList();
        showChapter(0);
        document.querySelectorAll('.chapter-btn')[0].classList.add('active');
        document.getElementById('chapter-list-panel').classList.remove('hidden');

        // 初始化右键菜单事件
        document.addEventListener('mouseup', function(e) {
            const selection = window.getSelection();
            if (selection.toString().length > 0) {
                selectedText = selection.toString();
                selectedRange = selection.getRangeAt(0);
                
                const contextMenu = document.getElementById('context-menu');
                contextMenu.style.display = 'block';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
            }
        });

        // 点击其他地方关闭右键菜单
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#context-menu')) {
                document.getElementById('context-menu').style.display = 'none';
            }
        });
    </script>
</body>
</html>
